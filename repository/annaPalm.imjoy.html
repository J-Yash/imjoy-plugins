
<docs lang="markdown">
# ANNA-PALM: deep learning massively accelerates super-resolution localization microscopy

Ouyang et al., Nat. Biotechnol. 2018, doi:10.1038/nbt.4106
  
Paper on Nature Biotechnology: https://rdcu.be/LGtc
</docs>

<config lang="json">
{
  "name": "ANNA-PALM",
  "type": "native-python",
  "version": "0.1.7",
  "api_version": "0.1.5",
  "description": "A plugin for training models with ANNA-PALM.",
  "tags": ["CPU", "GPU"],
  "ui": null,
  "inputs": null,
  "outputs": null,
  "icon": null,
  "env": {"CPU": ["conda create -n annapalm-cpu python=3.6"], "GPU": ["conda create -n annapalm-gpu python=3.6"]},
  "requirements": {
    "CPU": ["repo:https://github.com/imodpasteur/ANNA-PALM", "cmd:pip install -r ANNA-PALM/requirements.txt"],
    "GPU": ["repo:https://github.com/imodpasteur/ANNA-PALM", "pip: Pillow numpy==1.15.0 scipy matplotlib scikit-image tensorflow-gpu==1.8.0"]
  },
  "dependencies": ["oeway/ImJoy-Plugins:Im2Im-Dashboard", "https://gist.githubusercontent.com/oeway/39c1be6303c21bde8dc78a4d437124cd/raw/Start-ANNA-PALM.imjoy.html"]
}
</config>

<script lang="python">
import sys

sys.path.insert(0, './ANNA-PALM')

import os
import sys
import tensorflow as tf
from AnetLib.options.train_options import Options
from AnetLib.models.models import create_model
from smlm_datasets import create_data_sources
import asyncio
import base64
from io import BytesIO
from PIL import Image
import concurrent.futures
from imjoy import api


default_workdir = './workdir'
opt = Options().parse(['--workdir=./tmp_predict'])
opt.model = 'a_net_tensorflow'
opt.fineSize = 512
opt.batchSize = 1
opt.dim_ordering = 'channels_last'
opt.display_freq = 500
opt.use_resize_conv = True
opt.norm_A = 'mean_std'
opt.norm_B = 'min_max[0,1]'
opt.lambda_A = 50
opt.input_nc = 2
opt.lr_nc = 1
opt.lr_scale = 1.0/4.0
opt.lambda_LR = 0
opt.control_nc = 1
opt.add_data_type_control = True
opt.add_lr_channel = 'pseudo'
opt.print_freq = 3
opt.display_freq = 1

class ImJoyPlugin():
  async def setup(self):
    self.step = 0
    self.dialog = None
    #self.executor = concurrent.futures.ThreadPoolExecutor(
    #    max_workers=3,
    #)

  def resume(self):
    api.alert('plugin process resumed')

  async def run(self, my):
    self.dialog = await api.showDialog(type='Start-ANNA-PALM', data= {
        'options': {
            'Simulated Microtubules': {'callback': self.train_sim_tubulin, 'src': 'https://img.icons8.com/color/52/000000/processor.png'},
            'predict': {'callback': self.predict, 'src': 'https://img.icons8.com/color/52/000000/processor.png'}
        }
    })
  def abort(self):
    self.__abort = True

  async def train_sim_tubulin(self):
    if self.dialog is not None:
        self.dialog.close()
    opt.batchSize = 1
    api.showStatus('preparing data...')
    self.dash = await api.createWindow(type="Im2Im-Dashboard", name="ANNA-PALM Training", standalone=True, data={'display_mode':'one','metrics': ["discrim_loss", "gen_loss_GAN", "gen_loss", "gen_loss_L2", "gen_loss_SSIM", "squirrel_discrim_loss", "gen_loss_squirrel"], 'callbacks': ['onEpochEnd', 'onBatchEnd']})
    self.dash.onClose(self.abort)
    await self.dash.setLoading({'status_text': 'Preparing data...', 'loading': True})
    sources = create_data_sources(['TransformedTubulin001NB'], opt)
    d = sources['train']

    await self.dash.setLoading({'status_text': 'Start Training...', 'loading': True})
    await self.train(d, opt)
    #self.loop = asyncio.get_event_loop()
    #await asyncio.get_event_loop().run_in_executor(self.executor, self.train, d, opt)

  def sendImages(self, images):
    displays = {}
    for k, v in images.items():
        for b in range(v.shape[0]):
            ima = v[b]
            channels = ima.shape[2]
            for i in range(channels):
                im = ima[:, :, i]
                im = Image.fromarray((im/im.max()*255).astype('uint8'))
                buffered = BytesIO()
                im.save(buffered, format="JPEG")
                img_str = base64.b64encode(buffered.getvalue()).decode('ascii')
                imgurl = 'data:image/png;base64,' + img_str
                name = k
                if v.shape[0]>1:
                    name += '_b'+str(b)
                if channels>1:
                    name += '_c'+str(i)
                displays[name] = imgurl
                # api.createWindow(name=str(k)+str(b)+str(i) , type='imjoy/image', w=12, h=15, data={"src": imgurl})
    self.dash.appendDisplay('Training Step ' + str(self.step), displays)

  async def train(self, dataset, opt, steps=1000):
    #asyncio.set_event_loop(self.loop)
    self.__abort = False
    
    api.showStatus('start training...')
    model = create_model(opt)
    self.step = 0
    def step_callback(model, details):
        self.step += 1
        if self.step<3:
            self.dash.setLoading({'status_text': 'Start Training...', 'loading': False})
        try:
            if 'display' in details:
                images = details['display']
                del details['display']
                self.sendImages(images)
            api.showStatus('training: ' + str(details))
            api.log(str(details))
            api.progress(self.step/steps)
            print(details)
            self.dash.updateCallback('onEpochEnd', self.step, details)
            print(str(details))
            sys.stdout.flush()
        except:
            print('step callback error')
        if self.__abort:
            return 'stop'

    model.train(dataset, step_callback=step_callback, verbose=1, max_steps=steps)

  async def predict(self, my=None):
    self.dash = await api.createWindow(type="Im2Im-Dashboard", name="ANNA-PALM prediction", data={'display_mode':'one'})
    model = create_model(opt)
    sources = create_data_sources(['TransformedTubulin001NB'], opt)
    d = sources['predict']
    api.showStatus('start predicting...')
    self.step = 0
    def step_callback(model, details):
        self.step += 1
        try:
            if 'display' in details:
                images = details['display']
                del details['display']
                self.sendImages(images)
            api.showStatus('predicting: ' + str(details))
            print(str(details))
            api.log(str(details))
            sys.stdout.flush()
        except:
            print('step callback error')
    model.predict(d, step_callback=step_callback, verbose=1)

api.export(ImJoyPlugin())
</script>
