<docs>
This plugin is for dispalying 2d image.

</docs>

<config>
{
  "name": "Image Window",
  "mode": "iframe",
  "tags": ["2d", "op", "window"],
  "inputs": {"image":"image/grayscale"},
  "outputs": {"image":"image/grayscale"},
  "show_panel": true,
  "version": "0.1.0",
  "api_version": "0.1.0",
  "createdAt": "Mon Jun 19 2018 15:45:30",
  "url": "/imageWindow.html",
  "description": "A plugin for display simple image.",
  "icon": "image",
  "dependencies": []
}
</config>
<window>
  <div>
   <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css"
   integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ=="
   crossorigin=""/>
   <link rel="stylesheet" href="https://cdn.rawgit.com/leongersen/noUiSlider/aa64a6d9/distribute/nouislider.min.css"/>
   <div id="slider"></div>
   <div id="leaflet_canvas"></div>
  </div>
</window>

<script>
function array2url(imageArr, w, h, low, high){
  var canvas = document.createElement('canvas');
  canvas.width = w
  canvas.height = h
  var ctx = canvas.getContext("2d");
  var canvas_img = ctx.getImageData(0, 0, canvas.width, canvas.height)
  var canvas_img_data = canvas_img.data;
  var count = w*h
  var range = high -low
  var min = Number.POSITIVE_INFINITY, max= Number.NEGATIVE_INFINITY;
  var v
  if(range<=0){
    for(let i=0;i<count;i++){
        if(imageArr[i]>max) max=imageArr[i]
        if(imageArr[i]<min) min=imageArr[i]
    }
    low = min
    high = max
    range = max-min
  }
  for(let i=0;i<count;i++){
      if(imageArr[i]>max) max=imageArr[i]
      if(imageArr[i]<min) min=imageArr[i]

      v = (imageArr[i]-low)/range * 255
      v = v>255?255:v
      canvas_img_data[i*4] = v
      canvas_img_data[i*4+1] = v
      canvas_img_data[i*4+2] = v
      canvas_img_data[i*4+3] = 255
  }
  ctx.putImageData(canvas_img, 0, 0);
  return [canvas.toDataURL("image/png"), min, max, low, high]
}
class ImageWindowPlugin {
  async setup() {
    await importScripts("https://cdn.rawgit.com/leongersen/noUiSlider/aa64a6d9/distribute/nouislider.min.js")
    await importScripts("https://unpkg.com/leaflet@1.3.1/dist/leaflet.js")
    this._slider = document.getElementById('slider');
    const map = L.map('leaflet_canvas', {
      minZoom: -3,
      maxZoom: 3,
      center: [0, 0],
      zoom: -1,
      crs: L.CRS.Simple,
      zoomControl: false
    });
    this._map = map
    noUiSlider.create(this._slider, {
    	start: [0, 255],
    	connect: true,
    	range: {
    		'min': 0,
    		'max': 255
    	}
    });
    this._slider.noUiSlider.set([0, 0])
    this._slider.noUiSlider.on('change', ()=>{this.run(this._my)})
    this._my = null
  }
  run(my) {
      console.log('running image window', my)
    my = my || this._my
    if(!my || !my.data) return
    const map = this._map
    const range = this._slider.noUiSlider.get()
    console.log('pixel range: ', range)
    const [imageUrl, min, max, low, high] = array2url(my.data.image.array, my.data.image.width, my.data.image.height, parseInt(range[0]), parseInt(range[1]))
    this._slider.noUiSlider.updateOptions(
    	{range: {
    		'min': min,
    		'max': max
    	}}, // Object
    	true // Boolean 'fireSetEvent'
    );
    this._slider.noUiSlider.set([low, high])
    const w = my.data.image.width, h = my.data.image.height

    map.eachLayer(function(layer) {
      map.removeLayer(layer);
    });
    console.log(h, w)
    // this._canvas_data = imageData
    // dimensions of the image
    const southWest = map.unproject([0, h], 1);
    const northEast = map.unproject([w, 0], 1);
    const bounds = new L.LatLngBounds(southWest, northEast);
    // add the image overlay,
    // so that it covers the entire map
    if (this.inputLayer) {
      map.removeLayer(this.inputLayer)
      if (this.layerControl) {
        this.layerControl.removeLayer(this.inputLayer)
        if (this.outputLayer) {
          this.layerControl.removeLayer(this.outputLayer)
        }
      }
    }
    this.inputLayer = L.imageOverlay(imageUrl, bounds)
    this.inputLayer.addTo(map);
    if (!this.layerControl) {
      const baseLayers = {}
      const overlays = {}
      this.layerControl = L.control.layers(baseLayers, overlays, {
        position: 'topleft',
        collapsed: this.screenWidth < 600
      })
      this.layerControl.addTo(map);
      //add zoom control with your options
      L.control.zoom({
        position: 'topleft'
      }).addTo(map);
    }
    this.layerControl.addBaseLayer(this.inputLayer, 'input')
    // tell leaflet that the map is exactly as big as the image
    map.setMaxBounds(bounds);
    this._my = my;

  }
}

api.export(new ImageWindowPlugin())
</script>

<style>
#leaflet_canvas {
  height: 100%;
  width: 100%;
  z-index: 0;
}
.noUi-horizontal {
    height: 8px!important;
    left: 8px;
    width: calc(100% - 16px);
}
.noUi-horizontal .noUi-handle{
  height: 18px!important;
}
.noUi-handle:after, .noUi-handle:before{
  top:2px!important;
}
.noUi-connect{
  background: #abc1ff!important;
}
</style>
