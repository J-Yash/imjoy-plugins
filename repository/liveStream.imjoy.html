
<docs lang="markdown">
Describe your plugin here.
</docs>

<config lang="json">
{
  "name": "Live Stream",
  "mode": "pyworker",
  "version": "0.1.0",
  "api_version": "0.1.1",
  "createdAt": "Mon Jun 26 2018 15:45:30",
  "description": "A plugin for demonstrate streaming with python.",
  "tags": ["demo", "op"],
  "ui": "image processing with python",
  "inputs": null,
  "outputs": null,
  "icon": null,
  "env": null,
  "requirements": ["conda:ffmpeg && npm install ws"],
  "cmd": "python",
  "dependencies": []
}
</config>

<script lang="python">
import numpy as np
import subprocess
import time
import logging
import threading

def run_server():
    width = 512
    height = 512
    frame_size = width * height * 3  # 3 bytes for rgb24
    frame_dim = '{}x{}'.format(width, height)
    cmd = 'ffmpeg -f rawvideo -video_size {} -framerate 30 -pixel_format rgb24 -i pipe:0 -f mpegts -codec:v mpeg1video -s {}  -framerate 30 -b:v 1000k -bf 0 http://localhost:8081/supersecret'.format(frame_dim, frame_dim).split()
    relay = subprocess.Popen('node ./websocket-relay.js supersecret 8081 8082'.split(' '), shell=False, stdout=subprocess.PIPE)
    time.sleep(3)
    converter = subprocess.Popen(cmd, stdin=subprocess.PIPE, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
    while True:
        in_data = np.random.bytes(frame_size)
        converter.stdin.write(in_data)
    converter.stdin.close()
    converter.terminate()
    relay.terminate()


class PythonPlugin():
  def setup(self):
    print('running server')
    t = threading.Thread(target=run_server, args=())
    t.daemon = True
    t.start()

  def run(self, my):
    api.run("Live Stream Window")

api.export(PythonPlugin())
</script>
